import React, { Component } from 'react';
import styles from 'css/index';
import tabs from 'comp/modules/tabbar/test';
import {StoreList} from 'comp/modules/listview';
import { View, Text, Image, TouchableHighlight } from 'react-native';


function dealWithListItemData(data){
    let _data = []
    if (data && data.length){
        data.map( (item, i)=>{
            _data.push({ title: (
                <TouchableHighlight
                    key={'titem'+i}
                    style={styles.innerBg}
                    underlayColor="rgb(199, 199, 199)"
                    onPress={() => {
                        _router('web', {url: Config.domain+'?topic='+item._id})  // 路由到detail详情页，H5
                    }}>

                    <View style={styles.inner}>
                        <Image
                        source={{uri: item.img||'http://localhost:3000/images/logo128.png'}}
                        style={styles.thumbnail}
                        />
                        <View style={styles.rightPart}>
                            <Text style={styles.title}>{item.title.substring(0, 6)}</Text>
                            <Text style={styles.year}>{item.create_at}</Text>
                            <Text style={styles.subTitle}>{item.title.substring(0,14)}</Text>
                        </View>
                        <Image source={ images.leftTile } style={styles.dot} />
                    </View>

                </TouchableHighlight>
            )})
        })
    }
    return _data;
}

// 列表数据
function blogList(type){
    // 异步数据
    async function asyData(){
        let _data = await req( apis.dbdemo );   // 数据数组，    {JSON}
        let __data = dealWithListItemData(_data);   // 处理后的RN结构数组, {JSON}
        SAX.setter('PurePure', {data: __data})    // SAX插入结构数组到 PurePure
    }


    let count = 1;
    async function endLoadMoreTopic(e){
        if (!e) return false;
        if (!count) return false;
        let _data = await req( apis.dbdemo, {body: {page: count} } );   // 数据数组，    {JSON}
        if (_data.length){
            let __data = dealWithListItemData(_data);   // 处理后的RN结构数组, {JSON}
            SAX.append('PurePure', __data)
            SAX.runner('PurePure')
            count++;
        }
        else{
            count = false;
            SAX.setter('PurePure', {data:{renderFooter: false}})
            Toast.show('没有更多了')
            return false;
        }
    }

    // init data
    setTimeout(()=>{
        asyData()
    }, 0);

    return (
        <StoreList
            name='PurePure'
            onEndReached={endLoadMoreTopic}
        />
    )
}

export default blogList()
